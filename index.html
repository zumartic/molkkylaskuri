<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mölkky Pisteiden Laskuri</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }
    h1 {
      text-align: center;
    }
    #playerCountContainer {
      text-align: center;
      margin-bottom: 20px;
    }
    table {
      border-collapse: collapse;
      margin: auto;
      width: 100%;
      max-width: 100%;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      text-align: center;
      padding: 8px;
    }
    tfoot td {
      font-weight: bold;
      background: #eee;
    }
    input[type="number"], input[type="text"] {
      width: 60px;
      padding: 4px;
      text-align: center;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
    .winner {
      background-color: #c7f9cc !important;
    }
    .overlimit {
      background-color: #ffcccc !important;
    }
  </style>
</head>
<body>
  <h1>Mölkky Pisteiden Laskuri</h1>
  <div id="playerCountContainer">
    Pelaajien määrä:
    <select id="playerCount">
      <option value="1">1</option>
      <option value="2" selected>2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
    </select>
    <button onclick="initializeTable()">Aloita peli</button>
  </div>
  <div id="game"></div>
  <script>
    let currentPlayers = 2;

    function initializeTable() {
      currentPlayers = parseInt(document.getElementById("playerCount").value);
      localStorage.removeItem("molkkylaskuri");
      const container = document.getElementById("game");
      let html = `
        <div style="text-align:center;"><strong>Kierros: <span id="roundCounter">1</span></strong></div>
        <table id="scoreTable"><thead><tr><th>Kierros</th>`;

      for (let i = 1; i <= currentPlayers; i++) {
        html += `<th><input type="text" value="Pelaaja ${i}" onchange="saveData()" /></th>`;
      }

      html += `</tr></thead><tbody id="scoreBody"></tbody><tfoot><tr><td>Yhteensä</td>`;

      for (let i = 0; i < currentPlayers; i++) {
        html += `<td id="sum${i}">0</td>`;
      }

      html += `</tr></tfoot></table>
               <div style="text-align:center;">
                 <button onclick="resetScores()">Nollaa pisteet</button>
               </div>`;
      container.innerHTML = html;
      addRound();
    }

    function addRound() {
      const table = document.getElementById("scoreBody");
      const roundNumber = table.children.length + 1;
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${roundNumber}</td>` +
        Array.from({ length: currentPlayers }).map(() =>
          `<td><input type="number" min="0" max="12" oninput="updateSums()" /></td>`).join('');
      table.innerHTML = '';
      table.appendChild(tr);
      document.getElementById("roundCounter").textContent = roundNumber;
    }

    function updateSums() {
      const table = document.getElementById("scoreTable");
      const rows = document.querySelectorAll("#scoreBody tr");
      let totals = Array(currentPlayers).fill(0);
      let someoneWon = false;

      rows.forEach(row => {
        row.querySelectorAll("td").forEach(cell => {
          cell.classList.remove("overlimit");
        });
      });

      for (let i = 0; i < currentPlayers; i++) {
        let total = 0;
        for (let r = 0; r < rows.length; r++) {
          const input = rows[r].querySelectorAll("input")[i];
          let val = parseInt(input.value);
          if (!isNaN(val)) {
            total += val;
            if (total > 50) {
              alert(`Pelaaja ${i + 1} ylitti 50 pistettä kierroksella ${r + 1} – pistemäärä pudotetaan 25:een.`);
              for (let rr = 0; rr <= r; rr++) {
                const inp = rows[rr].querySelectorAll("input")[i];
                inp.value = '';
              }
              rows[r].querySelectorAll("input")[i].value = 25;
              rows[r].querySelectorAll("td")[i + 1].classList.add("overlimit");
              total = 25;
            }
          }
        }
        totals[i] = total;
        const cell = document.getElementById("sum" + i);
        cell.textContent = total;
        cell.classList.remove("winner");
        if (total === 50) {
          cell.classList.add("winner");
          someoneWon = true;
        }
      }

      document.getElementById("roundCounter").textContent = rows.length;

      const inputs = rows[rows.length - 1].querySelectorAll("input");
      const allFilled = Array.from(inputs).every(input => input.value !== "");
      if (!someoneWon && allFilled) {
        addRound();
      }

      saveData();
    }

    function resetScores() {
      if (!confirm("Haluatko varmasti nollata kaikki pisteet?")) return;
      localStorage.removeItem("molkkylaskuri");
      initializeTable();
    }

    function saveData() {
      // Lisätään tulevaa käyttöä varten jos halutaan tallennus myöhemmin
    }

    window.onload = () => {
      initializeTable();
      document.getElementById('playerCount').addEventListener('change', () => {
        initializeTable();
      });
    };
  </script>
</body>
</html>
